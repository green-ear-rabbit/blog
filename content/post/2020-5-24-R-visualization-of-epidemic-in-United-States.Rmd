---
title: "R-visualization-of-epidemic-in-United-States"
author: "Green Ear Rabbit"
date: "24/05/2020"
output:
  html_document:
    df_print: paged
mainfont: Palatino
fontsize: 13pt
subtitle: The characteristics of the COVID-19 outbreak in United States
bibliography: "reference/a1.bib"
link-citations: yes
biblio-style: apalike
always_allow_html: yes
---


# My research topic
COVID-19 has rapidly become a worldwide pandemic since December in 2019. China has controled the domestic cases effectively and timely by a series of polcy, e.g lockdown of Wuhan city, close of schools and company. However, United States has become the epicenter of this outbreak. 

U.S has adopted "mass screening" policy to identify cases, which is use rapid and wide testing to identify both active and inactive cases to control the further transmission.

However, we don't know if the "mass screening" is effective for disease control. Moreover, we don't know if the health systems are overload, if resources are limited. 

This assignment use the data from [COVID Tracking Project](https://docs.google.com/spreadsheets/u/2/d/e/2PACX-1vRwAqp96T9sYYq2-i7Tj0pvTf6XVHjDSMIKBdZHXiCGGdNC0ypEU9NbngS8mxea55JuCFuua1MUeOj5/pubhtml) in United States. Data were downloaded at 4pm ET. April 14th.

We mainly focus on following research questions:

 1. How's the results and effectiveness of 'mass screening' in U.S. ?
 2. How's the burden and chanlenge of health system in U.S. 
 3. How's the trend of mortality
 4. How's the geographic disrubution?
 5. Is there any difference of health care system performance between different states?


# Explore the trend
```{r include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

```{r}
require(tidyverse)
require(plotly)
```

Data download 
```{r}
md <- readr::read_csv("data/USvirus.csv")
```

some varibale names contatin some un-preferred symbols, let's change them.
```{r}
names(md)[6]<-"hospitalized_curr"
names(md)[7]<-"hospitalized_cumu"
names(md)[8]<-"icu_curr"
names(md)[9]<-"icu_cumu"
names(md)[10]<-"ventilator_curr"
names(md)[11]<-"ventilator_cumu"
```

by date
```{r}
require(tidyverse)
md_date <-
  md %>% group_by(Date) %>% summarise(
    positive_all_state = sum(Positive, na.rm = TRUE),
    negative_all_state = sum(Negative, na.rm = TRUE),
    pending_all_state = sum(Pending, na.rm = TRUE),
    hospitalized_curr_all_state = sum(hospitalized_curr, na.rm = TRUE),
    hospitalized_cumu_all_state = sum(hospitalized_cumu, na.rm = TRUE),
    icu_curr_all_sate = sum(icu_curr, na.rm = TRUE),
    icu_cumu_all_state = sum(icu_cumu, na.rm = TRUE),
    ventilator_curr_all_state = sum(ventilator_curr, na.rm = TRUE),
    ventilator_cumu_all_state = sum(ventilator_cumu, na.rm = TRUE),
    recover_all_state = sum(Recovered, na.rm = TRUE),
    death_all_state = sum(Deaths, na.rm = TRUE)
  )
```

```{r}
md_date$date2 <- as.Date(paste(substr(md_date$Date,1,4),substr(md_date$Date,5,6),substr(md_date$Date,7,8),sep = '-'))
```

```{r}
md_date_w <-
  md_date %>% select(-Date) %>%  gather(key = "type", value = "number",-date2)
```

Let's have a look at the epidemic in U.S.

```{r}
ggplot(md_date_w, aes(date2, number, color = type)) +
  geom_line(size = 0.8) +
  geom_point(pch = 19, size = 2) +
  theme_minimal(base_size = 14)+ 
   scale_colour_manual(labels=c("Total death","Cumulative patients in hospital","Current patients in hospital","Cumulative patients in ICU","Current patients in ICU","Total negative cases form testing","Pending in testing","Total positive cases from testing","Total recovered cases","Cumulative patients on ventilator", "Current patients on ventilator"),values = rainbow(11), name="Categories")+
 ggtitle("Figure 1: Exploration of the trend of the epidemic") +
  xlab("Calendar date") +
  ylab("Case number")
```

Because the range of cases is relatively various for different categories, the *Figure 1* might be difficult to provide clear and detailed information. Let's continous the exploration. 



# RQ1: How's the results and effectiveness of 'mass screening' in U.S.?

Following plots are to evaluate the effectiveness of "mass testing" policy


Let's have a look at cumulative results by 2020-04-13 before next step
```{r}
legendtitle <- list(yref='paper',xref="paper",y=1.03,x=1.15, text="Test results",showarrow=F)

md_date_w %>%
  filter(
    type %in% c("positive_all_state", "negative_all_state","pending_all_state")) %>%
  filter(date2==as.Date("2020-04-13")) %>% group_by(type) %>% plot_ly(labels = ~type, values = ~number , type = "pie") %>% 
layout(title ="Figure 2: Cumulative results from mass screening by 2020-04-13", annotations=legendtitle)
```


```{r include=FALSE}
#method 1: the silly method; result is hidden
data1<-subset(md_date_w, type=="positive_all_state"| type=="negative_all_state"| type=="pending_all_state")

ggplot(data1, aes(date2, number, color = type)) +
  geom_line(size = 0.8) +
  geom_point(pch = 19, size = 2) +
  theme_minimal(base_size = 14)

```

```{r}
# medthod 2: a better method
t2<-md_date_w %>%
  filter(type %in% c("positive_all_state","negative_all_state", "pending_all_state")) %>% filter(date2>as.Date("2020-03-21")) %>%
  ggplot(aes(date2, number, color = type)) +
  geom_point(pch = 19,
             size = 2) +  geom_line(size = 0.8) +
  theme_minimal(base_size = 14)+
 scale_color_manual(labels=c("Total negative cases from testing","Pending cases","Total positive cases from testing"),values = 1:3, name="Results from 'mass screening'")+
 ggtitle("Figure 3: Exploration of the results of mass screening") +
  xlab("Calendar date") +
  ylab("Case number")+
  geom_smooth(method = loess)
t2
```

As Figure 3 shows, the results of mass screening indicates that negative cases are always more than positive cases, and screening size is increasing since the March 21st. 



# RQ2: Let's evaluate the burden and chanlenge of health system in U.S. 
this plot is to evaluate the burden and effectiveness of health systems, we use current patients in hospitalized/in icu/ on ventilator. Becuse we aim to evaluate the burden for clinical settings, people recover/ death and people who are isolated in house/community will be excluded in the analysis. Only the current patients in hospital are analyzed.


```{r}
t3<-md_date_w %>%
  filter(
    type %in% c("hospitalized_curr_all_state", "icu_curr_all_sate", "ventilator_curr_all_state")) %>%
  filter(date2>as.Date("2020-03-21")) %>% 
  ggplot(aes(date2, number, color = type)) +
  geom_point(pch = 19,
             size = 2) +  geom_line(size = 0.8) +
  theme_minimal(base_size = 14) +
  scale_color_manual(labels=c("Current patients in hospital","Current patients in ICU","Current patients on ventilator"),values = 1:3, name="current patients in hospital")+
 ggtitle("Figure 4: Exploration of the chanllenges in clinical settings") +
  xlab("Calendar date") +
  ylab("Case number")+
  geom_smooth(method = loess)
t3
```


Figure 4 shows that both patients in hospital, patients in ICU and patients on ventilator are keeping increasing since Mar 21st. However, the number of three categroies tend to become flat since April 11th.

To further explore whther the trend is due to effectiveness of mass screening, next section will be focus on the death rate. 

# RQ3: The trend of death rate
let's make a bar chart to explore the recover and death

```{r}
md_date_w %>%
  filter(
    type %in% c("death_all_state", "recover_all_state")) %>%
  filter(date2>as.Date("2020-03-21")) %>% 
  ggplot() + geom_bar(aes(x = date2,y=number, fill = type),stat = 'identity', position = "dodge")+ 
  scale_colour_manual(labels=c("Total Death","Total Recovered"),values = rainbow(2), name="Outcomes of patients")+
 ggtitle("Figure 5: Exploration of the recovery and death in United States") +
  xlab("Calendar date") +
  ylab("Case number")
```

let's make a better one for rate 
```{r}
t5<-md_date_w %>%
  filter(
    type %in% c("death_all_state", "recover_all_state")) %>%
  filter(date2>as.Date("2020-03-21")) %>% 
  ggplot() + geom_bar(aes(x = date2,y=number, fill = type),stat = 'identity', position = "fill")+
  scale_colour_manual(labels=c("Total Death","Total Recovered"),values = rainbow(2), name="Outcomes of patients")+
 ggtitle("Figure 6: Exploration of the recovery rate in United States") +
  xlab("Calendar date") +
  ylab("Case number")
t5
```

As Table 5, Table 6 shows that the proportion of death and recover remain genrally unchanged. 



# RQ5: Is there any difference of healthcare system performance between different states?

We use mortality and proption of recovery as the measures of healthcare system performance.
```{r}
md2<-md
md2[is.na(md2)] = 0
names(md2)[2]<-"state"
```

```{r}
md2$mortality<-md2$Deaths/md2$Positive*100
md2$prop_of_recovery<-md2$Recovered/md2$Positive*100
```


```{r}
md2$date2 <- as.Date(paste(substr(md2$Date,1,4),substr(md2$Date,5,6),substr(md2$Date,7,8),sep = '-'))
```

```{r}
md3 <-
  md2 %>% filter(date2==as.Date("2020-04-13")) %>% select(-Date) %>%  gather(key = "measures", value = "percentage(%)",-c(state, Positive)) %>% filter(measures %in% c("mortality","prop_of_recovery"))  
```
boxplot
```{r}
md3 %>%  plot_ly(color = ~measures, y = ~`percentage(%)`,type = "box") %>% layout(title = "Figure 8: mortality and proprtion of recovey in each state in U.S")
```

Explanation of the outliner of mortality: When state is "MP"(Northern Mariana Islands), there is a significantly high mortality (18.18%). There is only 11 positive cases in Northern Mariana Island, and two of them died, by 2020-4-13. Because the relative small sample size comapre with other state, it's not a statistically informed results.

Explanation of the outliner of proportion of recovery: When state is "VI"(Virgin Islands), there is a significantly high proportion of recovery (84.31%). There is 51 confirmed cases, 43 recoved and 1 died. You may think that, it may due to the cases in this state is earlier, because the disease prognosis is slow, it's the reason we observe a high proportion of recovery. Okay, let's have a look if it is true.

Then let's visulize the daily increase case (not cumulative case) by each state, but we problem is that there is 56 states or areas, it's rather difficult to visualize clearly in a plot. When you don't know how to select sample, randomization is the best choose. 
```{r}
vi<-subset(md,State=="VI")
vi$prev<-c(as.matrix(vi[-1,3]),0)
vi$new<-vi$Positive-vi$prev
nc<-subset(md,State=="NC")
nc$prev<-c(as.matrix(nc[-1,3]),0)
nc$new<-nc$Positive-nc$prev
ak<-subset(md,State=="AK")
ak$prev<-c(as.matrix(ak[-1,3]),0)
ak$new<-ak$Positive-ak$prev
ct<-subset(md,State=="CT")
ct$prev<-c(as.matrix(ct[-1,3]),0)
ct$new<-ct$Positive-ct$prev
va<-subset(md,State=="VA")
va$prev<-c(as.matrix(va[-1,3]),0)
va$new<-va$Positive-va$prev
look<-rbind(vi,nc,ak,ct,va)
```

```{r}
look$date2 <- as.Date(paste(substr(look$Date,1,4),substr(look$Date,5,6),substr(look$Date,7,8),sep = '-'))
```

```{r}
look %>%
  ggplot(aes(date2, new, color = State)) +
  geom_point(pch = 19,
             size = 2) +  geom_line(size = 0.8) +
  theme_minimal(base_size = 14)+
 ggtitle("Figure 9: Daily new diagnosis case number in five state") +
  xlab("Calendar date") +
  ylab("New diagnosis case number")
```
As Figure 9 shows that, we didnot found that VI has a significantly more diagnosis number in earlier stage. So, the high recovery probability and faster recovery may be due to the nice air quality in Virgin Islands, which will help the recovery in lungs. Of cource, we cannot exclude the sample size is small.


So if there is any relationship between diagnosis case number and mortality/ proportion of recovery? If so, it may suggest that the healthcare system in some states may be overload, and some preventable death are due to inability to get medical treatment.

```{r}
md3 %>% plot_ly(x= ~Positive, y = ~`percentage(%)`, color = ~measures, type = "scatter") %>% layout(title = 'Figure 10: relationship between diagnosis case number and mortality/ proportion of recovery')
```

There seems no clear relationship for
 - Positive cases and mortality
 - Positive cases and proption of recovery

If up-limt of workload in healthcare system were reached, we would observed that there is negative association between positive cases in state and mortality. 

This figure indicates that, by 2020-04-13, there still not reach the up-limt of healthcare system, and healthcare system is overall well-performed. 

# Conclusion
This brief analysis focus on five research questions and provide nice visualizations. By 2020-4-13, mass-screening is effective to identify cases, and the healthcare system to treat patients is well preformed.

There is some difference in states. New York State has much more cases than other state. Virgin Islands has higher recovery probability and faster recovery of disease. 

However, more data is needed and further follow-up is necessary to draw more valid conclusion


# References:


